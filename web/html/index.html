<!DOCTYPE html>
<html lang="zh-Hans-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/img/home.png" />
    <title>Sensor</title>
    <script src="https://cdn.jsdelivr.net.cn/npm/chart.js"></script>
    <style type="text/css">
        body {
            font-family: "Segoe UI", Segoe, Tahoma, Arial, Verdana, sans-serif;
            background-color: white;
            overflow: hidden;
            width: 100%;
            height: 100%
        }

        select {
            font-size: 18px;
        }
    </style>
</head>

<body class="b_dark">
    <script>
        let chart;
        const MAX_POINTS = 300;

        function createChart(labels = [], temperatures = [], humidities = []) {
            const ctx = document.getElementById('sensorChart');
            if (chart) {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.data.datasets[1].data = [];
                chart.update();
                return;
            }

            chart = new Chart(ctx, {
                data: {
                    labels: labels,
                    datasets: [{
                        type: 'line',
                        label: '温度',
                        borderColor: 'red',
                        data: temperatures,
                        borderWidth: 2,
                        tension: 0,
                        pointRadius: 0,
                        borderColor: '#FF6384',
                        backgroundColor: '#FFB1C1',
                    },
                    {
                        type: 'line',
                        label: '湿度',
                        borderColor: 'blue',
                        data: humidities,
                        borderWidth: 2,
                        tension: 0,
                        pointRadius: 0,
                        borderColor: '#36A2EB',
                        backgroundColor: '#9BD0F5',
                    }
                    ]
                },
                plugins: [{
                    afterDraw: chart => {
                        if (chart.tooltip?._active?.length) {
                            let x = chart.tooltip._active[0].element.x;
                            let yAxis = chart.scales.y;
                            let ctx = chart.ctx;
                            ctx.save();
                            ctx.beginPath();
                            ctx.moveTo(x, yAxis.top);
                            ctx.lineTo(x, yAxis.bottom);
                            ctx.lineWidth = 1;
                            ctx.strokeStyle = 'rgba(0, 0, 255, 0.4)';
                            ctx.stroke();
                            ctx.restore();
                        }
                    }
                }],
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '温度 (°C)',
                            },
                            position: 'left',
                        },
                        y1: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '湿度 (%)',
                            },
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                        x: {
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sensor'
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    spanGaps: true,
                }
            });
        }

        function makeWsUrl() {
            const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
            return proto + location.host + '/ws/api/sensor/get';
        }

        let ws;
        let reconnectTimer = null;
        let reconnectDelay = 1000;
        let offset = 0;

        function connectWs(idx = 0) {
            console.log('Connecting WS with offset: ', idx);
            const statusEl = document.getElementById('wsStatus');
            if (ws) {
                ws.onclose = null;
                ws.onerror = null;
                ws.onopen = null;
                ws.onmessage = null;
                ws.close();
                ws = null;
            }

            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }

            offset = idx;

            const url = makeWsUrl();
            try {
                ws = new WebSocket(url);
            } catch (e) {
                console.error('WebSocket create ', e);
                scheduleReconnect();
                return;
            }

            ws.addEventListener('message', (ev) => {
                try {
                    const data = ev.data.split(';');
                    console.log('Message length: ', data.length);
                    offset += data.length;
                    data.forEach(entry => {
                        const parts = entry.split(':');
                        if (parts.length < 2) return;
                        const minutes = parseInt(parts[0]);
                        const hours = Math.floor(minutes / 60);
                        const mins = minutes % 60;
                        const timeLabel = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
                        let temp = Number(parts[1]) / 10;
                        let hum = Number(parts[2] ?? 0.0) / 10;
                        if (timeLabel && temp != null && hum != null) {
                            console.debug('appending: ', timeLabel, temp, hum);
                            chart.data.labels.push(timeLabel);
                            chart.data.datasets[0].data.push(temp);
                            chart.data.datasets[1].data.push(hum);
                        }
                    });
                    chart.update();
                } catch (e) {
                    console.error('Message error', e, ev.data);
                    ws.close();
                }
            });

            ws.addEventListener('close', () => {
                console.log('WebSocket close');
                statusEl.textContent = 'DISCONNECTED';
                scheduleReconnect();
            });

            ws.addEventListener('error', (e) => {
                console.log('WebSocket error', e);
                statusEl.textContent = 'ERROR';
                ws.close();
            });

            ws.addEventListener('open', () => {
                console.log('WebSocket open')
                statusEl.textContent = 'CONNECTED';
                reconnectDelay = 1000;

                const d = document.getElementById('dateSelect').value;
                ws.send(JSON.stringify({ date: d, offset: offset }));
            });
        }

        function scheduleReconnect() {
            if (reconnectTimer)
                return;
            reconnectTimer = setTimeout(() => {
                connectWs(offset);
                reconnectDelay = Math.min(16000, reconnectDelay * 2);
            }, reconnectDelay);
        }

        function startChart() {
            createChart();
            // 初始化：加载今天的数据并连接 WS
            connectWs();
        }

        window.onload = function () {
            startChart();
        };
    </script>

    <div style="display:flex;height:40px;gap:12px;align-items:center;margin-bottom:12px;margin-top:12px">
        <select id="dateSelect">
            <script>
                const dateSelect = document.getElementById('dateSelect');
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const option = document.createElement('option');
                    const dateString = date.toLocaleDateString('zh', { year: 'numeric', month: '2-digit', day: '2-digit' }).replaceAll('/', '-');

                    option.value = dateString.replaceAll('-', '_');
                    option.textContent = dateString;
                    dateSelect.appendChild(option);
                }
                dateSelect.addEventListener('change', function () {
                    startChart();
                });
            </script>
        </select>
        <div> WS: <span id="wsStatus">DISCONNECTED</span></div>
    </div>
    <canvas id="sensorChart"></canvas>
</body>

</html>