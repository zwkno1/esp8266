<!DOCTYPE html>
<html lang="zh-Hans-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/img/home.png" />
    <title>Sensor</title>
    <script src="https://cdn.jsdelivr.net.cn/npm/chart.js"></script>
    <style type="text/css">
        body {
            font-family: "Segoe UI", Segoe, Tahoma, Arial, Verdana, sans-serif;
            background-color: white;
            overflow: hidden;
            width: 100%;
            height: 100%
        }

        select {
            font-size: 18px;
        }
    </style>
</head>

<body class="b_dark">
    <script>
        let chart;
        const MAX_POINTS = 300;

        function createChart(labels = [], temperatures = [], humidities = []) {
            const ctx = document.getElementById('sensorChart');
            if (chart) {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.data.datasets[1].data = [];
                chart.update();
                return;
            }

            chart = new Chart(ctx, {
                data: {
                    labels: labels,
                    datasets: [{
                        type: 'line',
                        label: '温度',
                        borderColor: 'red',
                        data: temperatures,
                        borderWidth: 2,
                        tension: 0,
                        pointRadius: 0,
                        borderColor: '#FF6384',
                        backgroundColor: '#FFB1C1',
                    },
                    {
                        type: 'line',
                        label: '湿度',
                        borderColor: 'blue',
                        data: humidities,
                        borderWidth: 2,
                        tension: 0,
                        pointRadius: 0,
                        borderColor: '#36A2EB',
                        backgroundColor: '#9BD0F5',
                    }
                    ]
                },
                plugins: [{
                    afterDraw: chart => {
                        if (chart.tooltip?._active?.length) {
                            let x = chart.tooltip._active[0].element.x;
                            let yAxis = chart.scales.y;
                            let ctx = chart.ctx;
                            ctx.save();
                            ctx.beginPath();
                            ctx.moveTo(x, yAxis.top);
                            ctx.lineTo(x, yAxis.bottom);
                            ctx.lineWidth = 1;
                            ctx.strokeStyle = 'rgba(0, 0, 255, 0.4)';
                            ctx.stroke();
                            ctx.restore();
                        }
                    }
                }],
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '温度 (°C)',
                            },
                            position: 'left',
                        },
                        y1: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '湿度 (%)',
                            },
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                        x: {
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sensor'
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    spanGaps: true,
                }
            });
        }

        let ctx;
        let ws;

        class SensorSocket {
            constructor(date) {
                this.date = date;
                this.offset = 0;
            }

            url() {
                const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
                return proto + location.host + '/ws/api/sensor/get';
            }

            connect() {
                if (this.timerId) {
                    this.timerId = null;
                }

                this.ws = new WebSocket(this.url());

                this.ws.onopen = () => {
                    if (this.onopen) {
                        this.onopen();
                    }
                    this.ws.send(JSON.stringify({ date: this.date, offset: this.offset }));
                };

                this.ws.onmessage = (msg) => {
                    try {
                        if (typeof msg.data !== "string") {
                            console.info("Message error", typeof msg.data);
                            this.offset += 1;
                            return;
                        }
                        const data = msg.data.split(';');
                        console.log('Message length: ', data.length);
                        this.offset += Math.max(data.length, 1);
                        if (this.onmessage) {
                            this.onmessage(data);
                        }
                    }
                    catch (e) {
                        console.error('Message error', e, msg.data);
                        const statusEl = document.getElementById('wsStatus');
                        statusEl.textContent = 'ERROR';
                        this.offset += 1;
                    }
                };

                this.ws.onclose = () => {
                    if (this.onclose) {
                        this.onclose();
                    }
                    if (this.timerId) {
                        return;
                    }
                    this.timerId = setTimeout(() => this.connect(), 3000);
                };

                this.ws.onerror = (err) => {
                    if (this.onerror) {
                        this.onerror();
                    }

                    if (this.timerId) {
                        return;
                    }
                    this.timerId = setTimeout(() => this.connect(), 3000);
                };
            }

            close() {
                this.onclose = null;
                this.onopen = null;
                this.onmessage = null;
                this.onclose = null;

                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }

                if (this.timerId) {
                    clearTimeout(this.timerId);
                    this.timerId = null;
                }
            }
        }

        function connectWs(date) {
            if (ws) {
                ws.close();
            }

            ws = new SensorSocket(date);

            const statusEl = document.getElementById('wsStatus');

            ws.onmessage = (data) => {
                data.forEach(entry => {
                    const parts = entry.split(':');
                    if (parts.length < 2) return;
                    const minutes = parseInt(parts[0]);
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    const timeLabel = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
                    let temp = Number(parts[1]) / 10;
                    let hum = Number(parts[2] ?? 0.0) / 10;
                    if (timeLabel && temp != null && hum != null) {
                        console.debug('appending: ', timeLabel, temp, hum);
                        chart.data.labels.push(timeLabel);
                        chart.data.datasets[0].data.push(temp);
                        chart.data.datasets[1].data.push(hum);
                    }
                });
                chart.update();
            };

            ws.onclose = (e) => {
                console.log('WebSocket close', e);
                statusEl.textContent = 'DISCONNECTED';
            };

            ws.onerror = (e) => {
                console.log('WebSocket error', e);
                statusEl.textContent = 'ERROR';
                //ws.close();
            };

            ws.onopen = () => {
                console.log('WebSocket open')
                statusEl.textContent = 'CONNECTED';
            };

            ws.connect();
        }

        function startChart() {
            createChart();
            // 初始化：加载今天的数据并连接 WS
            const date = document.getElementById('dateSelect').value;
            connectWs(date);
        }

        window.onload = function () {
            startChart();
        };
    </script>

    <div style="display:flex;height:40px;gap:12px;align-items:center;margin-bottom:12px;margin-top:12px">
        <select id="dateSelect">
            <script>
                const dateSelect = document.getElementById('dateSelect');
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const option = document.createElement('option');
                    const dateString = date.toLocaleDateString('zh', { year: 'numeric', month: '2-digit', day: '2-digit' }).replaceAll('/', '-');

                    option.value = dateString.replaceAll('-', '_');
                    option.textContent = dateString;
                    dateSelect.appendChild(option);
                }
                dateSelect.addEventListener('change', function () {
                    startChart();
                });
            </script>
        </select>
        <div> WS: <span id="wsStatus">DISCONNECTED</span></div>
    </div>
    <canvas id="sensorChart"></canvas>
</body>

</html>